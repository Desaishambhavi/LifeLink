<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LifeLink - Real-Time Health Monitoring</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --neon-blue: #00c6ff;
            --neon-purple: #7700ff;
            --neon-cyan: #00ffea;
            --dark-bg: #0a0e17;
            --card-bg: #12192e;
            --glow-intensity: 0 0 10px;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background-color: var(--dark-bg);
            color: #fff;
            overflow-x: hidden;
            background-image: 
                radial-gradient(circle at 10% 20%, rgba(119, 0, 255, 0.1) 0%, transparent 20%),
                radial-gradient(circle at 90% 80%, rgba(0, 198, 255, 0.1) 0%, transparent 20%);
        }

        /* Header Styles */
        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1.5rem 5%;
            background-color: rgba(10, 14, 23, 0.9);
            border-bottom: 1px solid rgba(0, 198, 255, 0.2);
            position: sticky;
            top: 0;
            z-index: 100;
            backdrop-filter: blur(10px);
        }

        .logo {
            font-size: 2rem;
            font-weight: 700;
            background: linear-gradient(45deg, var(--neon-blue), var(--neon-purple));
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
            text-shadow: var(--glow-intensity) rgba(119, 0, 255, 0.5);
        }

        nav ul {
            display: flex;
            list-style: none;
            gap: 2rem;
        }

        nav a {
            color: #fff;
            text-decoration: none;
            font-weight: 500;
            transition: all 0.3s ease;
            padding: 0.5rem 1rem;
            border-radius: 4px;
        }

        nav a:hover {
            color: var(--neon-cyan);
            text-shadow: var(--glow-intensity) var(--neon-cyan);
        }

        /* Page Container */
        .page {
            padding: 2rem 5%;
        }

        /* Dashboard Page */
        .home-title {
            font-size: 3.5rem;
            margin-bottom: 1.5rem;
            background: linear-gradient(45deg, var(--neon-blue), var(--neon-purple));
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
            text-shadow: var(--glow-intensity) rgba(119, 0, 255, 0.5);
        }

        .home-subtitle {
            font-size: 1.2rem;
            margin-bottom: 2rem;
            color: #a0aec0;
            line-height: 1.6;
        }

        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 2rem;
            margin-top: 2rem;
        }

        .health-card {
            background: var(--card-bg);
            border-radius: 15px;
            padding: 1.5rem;
            box-shadow: 0 0 15px rgba(0, 198, 255, 0.1);
            border: 1px solid rgba(0, 198, 255, 0.1);
            transition: all 0.3s ease;
            transform-style: preserve-3d;
            transform: translateZ(0);
        }

        .health-card:hover {
            transform: translateY(-5px) translateZ(10px);
            box-shadow: 0 0 20px rgba(0, 198, 255, 0.3);
        }

        .health-card.wide {
            grid-column: span 2;
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .card-title {
            font-size: 1.2rem;
            font-weight: 600;
        }

        .card-icon {
            font-size: 1.5rem;
            color: var(--neon-cyan);
        }

        .card-value {
            font-size: 2.5rem;
            font-weight: 700;
            margin: 1rem 0;
            background: linear-gradient(45deg, var(--neon-blue), var(--neon-cyan));
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
        }

        .card-status {
            display: inline-block;
            padding: 0.3rem 0.8rem;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
        }

        .status-normal {
            background: rgba(0, 255, 0, 0.1);
            color: #00ff00;
        }

        .status-warning {
            background: rgba(255, 165, 0, 0.1);
            color: #ffa500;
        }

        .status-critical {
            background: rgba(255, 0, 0, 0.1);
            color: #ff4757;
        }

        .progress-bar {
            height: 8px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 4px;
            margin-top: 1rem;
            overflow: hidden;
        }

        .progress {
            height: 100%;
            border-radius: 4px;
        }

        .gps-info {
            margin-top: 1rem;
            padding: 1rem;
            background: rgba(0, 198, 255, 0.05);
            border-radius: 10px;
            border: 1px solid rgba(0, 198, 255, 0.2);
        }

        .gps-data {
            display: flex;
            justify-content: space-between;
            margin-bottom: 0.5rem;
        }

        .gps-label {
            color: var(--neon-cyan);
            font-weight: 600;
        }

        .map-container {
            margin-top: 1rem;
            border-radius: 10px;
            overflow: hidden;
            height: 300px;
            background: rgba(0, 198, 255, 0.05);
            border: 1px solid rgba(0, 198, 255, 0.2);
        }

        .map-container iframe {
            width: 100%;
            height: 100%;
            border: 0;
        }

        /* AI Analysis Section */
        .ai-analysis {
            background: var(--card-bg);
            border-radius: 15px;
            padding: 2rem;
            margin-top: 2rem;
            box-shadow: 0 0 15px rgba(0, 198, 255, 0.1);
            border: 1px solid rgba(0, 198, 255, 0.2);
        }

        .ai-header {
            display: flex;
            align-items: center;
            margin-bottom: 1.5rem;
        }

        .ai-icon {
            font-size: 2rem;
            color: var(--neon-cyan);
            margin-right: 1rem;
        }

        .ai-suggestions {
            background: rgba(0, 198, 255, 0.05);
            border-radius: 10px;
            padding: 1.5rem;
            border: 1px solid rgba(0, 198, 255, 0.2);
            min-height: 100px;
        }

        .suggestion-item {
            margin-bottom: 0.8rem;
            padding: 0.8rem;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 8px;
            border-left: 3px solid var(--neon-cyan);
        }

        .btn {
            padding: 0.8rem 1.5rem;
            border-radius: 50px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            border: none;
            font-size: 0.9rem;
            margin-top: 1rem;
        }

        .btn-primary {
            background: linear-gradient(45deg, var(--neon-blue), var(--neon-purple));
            color: white;
            box-shadow: 0 0 15px rgba(119, 0, 255, 0.5);
        }

        .btn-secondary {
            background: linear-gradient(45deg, var(--neon-cyan), var(--neon-blue));
            color: white;
            box-shadow: 0 0 15px rgba(0, 198, 255, 0.5);
            margin-left: 1rem;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 0 20px rgba(119, 0, 255, 0.7);
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .last-update {
            text-align: center;
            margin-top: 2rem;
            color: #a0aec0;
            font-size: 0.9rem;
        }

        .loading {
            color: var(--neon-cyan);
            text-align: center;
            font-style: italic;
        }

        /* 3D Elements */
        .floating-element {
            position: absolute;
            width: 100px;
            height: 100px;
            border-radius: 50%;
            background: linear-gradient(45deg, var(--neon-blue), var(--neon-purple));
            opacity: 0.2;
            filter: blur(20px);
            animation: float 8s ease-in-out infinite;
            z-index: -1;
        }

        .element-1 {
            top: 20%;
            left: 5%;
            width: 150px;
            height: 150px;
            animation-delay: 0s;
        }

        .element-2 {
            top: 60%;
            right: 10%;
            width: 120px;
            height: 120px;
            animation-delay: 1s;
        }

        .element-3 {
            bottom: 10%;
            left: 20%;
            width: 80px;
            height: 80px;
            animation-delay: 2s;
        }

        /* Animations */
        @keyframes float {
            0% { transform: translateY(0) rotate(0deg); }
            50% { transform: translateY(-20px) rotate(10deg); }
            100% { transform: translateY(0) rotate(0deg); }
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            nav ul {
                gap: 1rem;
            }
            
            .home-title {
                font-size: 2.5rem;
            }
            
            .dashboard-grid {
                grid-template-columns: 1fr;
            }

            .health-card.wide {
                grid-column: span 1;
            }

            .btn-secondary {
                margin-left: 0;
                margin-top: 0.5rem;
            }
        }
    </style>
</head>
<body>
    <!-- Header -->
    <header>
        <div class="logo">LifeLink</div>
        <nav>
            <ul>
                <li><a href="homepage.html" class="nav-link">Home</a></li>
                <li><a href="reportt.html" class="nav-link">Health Data</a></li>
                <li><a href="profile.html" class="nav-link">Profile</a></li>
                <li><a href="reminder.html" class="nav-link">Reminder</a></li>
            </ul>
        </nav>
    </header>

    <!-- 3D Floating Elements -->
    <div class="floating-element element-1"></div>
    <div class="floating-element element-2"></div>
    <div class="floating-element element-3"></div>

    <!-- Dashboard Page -->
    <section id="dashboard" class="page">
        <h1 class="home-title">Real-Time Health Monitoring</h1>
        <p class="home-subtitle">Track your vital signs and health metrics in real-time with advanced medical IoT sensors.</p>
        
        <div class="dashboard-grid">
            <div class="health-card">
                <div class="card-header">
                    <h3 class="card-title">Heart Rate</h3>
                    <div class="card-icon"><i class="fas fa-heart"></i></div>
                </div>
                <div class="card-value" id="heartRateValue">-- BPM</div>
                <div class="card-status" id="heartRateStatus">Loading...</div>
                <div class="progress-bar">
                    <div class="progress" id="heartRateProgress" style="width: 0%; background: linear-gradient(45deg, var(--neon-blue), var(--neon-purple));"></div>
                </div>
            </div>
            
            <div class="health-card">
                <div class="card-header">
                    <h3 class="card-title">Oxygen Level</h3>
                    <div class="card-icon"><i class="fas fa-lungs"></i></div>
                </div>
                <div class="card-value" id="spo2Value">--%</div>
                <div class="card-status" id="spo2Status">Loading...</div>
                <div class="progress-bar">
                    <div class="progress" id="spo2Progress" style="width: 0%; background: linear-gradient(45deg, var(--neon-cyan), var(--neon-blue));"></div>
                </div>
            </div>
            
            <div class="health-card wide">
                <div class="card-header">
                    <h3 class="card-title">GPS Location</h3>
                    <div class="card-icon"><i class="fas fa-map-marker-alt"></i></div>
                </div>
                <div class="gps-info">
                    <div class="gps-data">
                        <span class="gps-label">Latitude:</span>
                        <span id="gpsLatitude">--</span>
                    </div>
                    <div class="gps-data">
                        <span class="gps-label">Longitude:</span>
                        <span id="gpsLongitude">--</span>
                    </div>
                    <div class="gps-data">
                        <span class="gps-label">Satellites:</span>
                        <span id="gpsSatellites">--</span>
                    </div>
                </div>
                <div class="card-status" id="gpsStatus">Waiting for GPS data</div>
                
                <!-- Google Maps Embed -->
                <div class="map-container">
                    <iframe 
                        id="googleMap"
                        allowfullscreen="" 
                        loading="lazy" 
                        referrerpolicy="no-referrer-when-downgrade"
                        src="about:blank">
                    </iframe>
                </div>
            </div>
        </div>

        <!-- AI Analysis Section -->
        <div class="ai-analysis">
            <div class="ai-header">
                <div class="ai-icon"><i class="fas fa-robot"></i></div>
                <div>
                    <h2>AI Health Analysis</h2>
                    <p>Get personalized health suggestions based on your current vitals</p>
                </div>
            </div>
            
            <div class="ai-suggestions" id="aiSuggestions">
                <div class="loading">Waiting for health data to generate suggestions...</div>
            </div>
            
            <button class="btn btn-primary" id="analyzeBtn">
                <i class="fas fa-brain" style="margin-right: 0.5rem;"></i>
                Get Health Suggestions
            </button>
            <button class="btn btn-secondary" id="speakBtn" style="display: none;">
                <i class="fas fa-volume-up" style="margin-right: 0.5rem;"></i>
                <span id="speakBtnText">Play Analysis</span>
            </button>
        </div>

        <div class="last-update" id="lastUpdate">
            Last updated: --
        </div>
    </section>

    <!-- Firebase SDK -->
    <script type="module">
        // Import the functions you need from the SDKs you need
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js";
        import { getDatabase, ref, onValue } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-database.js";

        // Your web app's Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyBdSoee19xeRhejBcvGJRiAIiMEEkS2wKA",
            authDomain: "lifelink-e7e3a.firebaseapp.com",
            projectId: "lifelink-e7e3a",
            storageBucket: "lifelink-e7e3a.firebasestorage.app",
            messagingSenderId: "56154827817",
            appId: "1:56154827817:web:d834413e1dc99f6d124038",
            measurementId: "G-F9S6YWYWCG"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const database = getDatabase(app);

        // Store current health data
        let currentHealthData = {};
        let currentAnalysisText = '';
        let speechSynthesis = window.speechSynthesis;
        let currentUtterance = null;

        // Reference to the sensorData in Firebase
        const sensorDataRef = ref(database, 'sensorData');

        // Function to call Gemini API for health analysis
        async function getHealthAnalysis(healthData) {
            const GEMINI_API_KEY = 'AIzaSyDlqjHFgaXKrVrfseD5vlbIjCMUl9FVrlw'; // Replace with your actual API key
            
            const prompt = `As a medical AI assistant, analyze this health data and provide 3-4 concise, actionable suggestions:
            Descriptive Statistics
A quick look at the data shows the distribution of values for each metric.

Oxygen Saturation (SpO2): This measures the percentage of oxygen in the blood. Normal levels for a healthy person are typically between 95% and 100%. The data seems to have a wide range of values, but most fall within this normal range, with some instances of lower readings. Readings of 92% or less require urgent medical advice. Levels below 90% are considered hypoxemic, and below 85% is considered severely hypoxemic, likely requiring supplemental oxygen.

Pulse Rate (bpm): This measures the heart rate in beats per minute. Normal resting heart rates are generally considered to be between 40 and 100 bpm. A fast heart rate, or tachycardia, is a symptom of low oxygen levels. The data shows a wide range of pulse rates, from very low to very high. Readings of 110-130 bpm suggest seeking advice from a GP, while readings of 131 bpm or more require urgent medical attention.

Relationship between Oxygen and Pulse Rate
Typically, there's an inverse relationship between oxygen saturation and heart rate, especially in cases of hypoxia (low blood oxygen). When oxygen levels drop, the heart rate often increases to compensate and pump oxygenated blood more quickly to the body's tissues. This is a natural response to try and maintain proper function.

A quick analysis shows that high pulse rates often coincide with lower oxygen saturation levels, while normal or low pulse rates are generally seen with normal oxygen saturation.

While an elevated pulse rate can be a symptom of low oxygen, it's not the only factor, and the link may not be strong enough to rely on in all cases.

Decision-Making Recommendations
Based on this analysis, the following values can be used as a basis for decision-making:

Normal Range: If a person's oxygen saturation is 96% or more and their pulse rate is between 40-100 bpm, their vital signs are considered normal.

Acceptable Range for Monitoring: An oxygen saturation of 95% with a pulse rate of 101-109 bpm is acceptable for home monitoring, but indicates a need for increased vigilance.

Warning Signs (Seek GP Advice): Readings of oxygen saturation between 93-94% or a pulse rate between 110-130 bpm are warning signs. At these levels, medical advice should be sought from a general practitioner. A drop of 3% or more in SpO2, even if still in the normal range, may also be an indicator of an acute illness and warrants a fuller assessment.

Critical Condition (Urgent Medical Attention): Readings of oxygen saturation at 92% or less, or a pulse rate of 131 bpm or more, are considered critical and require immediate emergency medical assistance (e.g., calling 999).

Further Analysis
While this basic analysis provides a solid foundation, further insights could be gained by building a predictive model using regression analysis. This would allow for a more precise understanding of how changes in oxygen levels could predict changes in pulse rate. Analyzing the data over time for a single individual could also reveal important trends that are not visible in a static snapshot of all data points. However, it's important to remember that pulse oximeter readings can sometimes be inaccurate due to factors like cold skin, poor circulation, or even dark nail polish.
            
            Current Health Metrics:
            - Heart Rate: ${healthData.heartRate} BPM
            - Oxygen Level (SpO2): ${healthData.spo2}%
            - SpO2 Valid: ${healthData.spo2Valid}
            ${healthData.gps?.latitude && healthData.gps?.longitude ? `- Location: Latitude ${healthData.gps.latitude}, Longitude ${healthData.gps.longitude}` : ''}
            
            Please provide short, practical health suggestions based on these readings. Focus on:
            1. Immediate actions if any metrics are concerning
            2. Lifestyle adjustments to maintain optimal levels
            3. When to seek medical attention if needed
            4. General wellness tips
            
            Keep each suggestion brief and actionable. Format as bullet points.`;

            try {
                const response = await fetch(`https://generativelanguage.googleapis.com/v1/models/gemini-2.5-flash:generateContent?key=${GEMINI_API_KEY}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        contents: [{
                            parts: [{
                                text: prompt
                            }]
                        }]
                    })
                });

                const data = await response.json();
                
                if (data.candidates && data.candidates[0].content.parts[0].text) {
                    return data.candidates[0].content.parts[0].text;
                } else {
                    throw new Error('No response from Gemini API');
                }
            } catch (error) {
                console.error('Error calling Gemini API:', error);
                return "I'm currently unable to analyze your health data. Please try again later or consult with your healthcare provider.";
            }
        }

        // Function to display suggestions
        function displaySuggestions(suggestionsText) {
            const suggestionsContainer = document.getElementById('aiSuggestions');
            
            // Store the analysis text for voice output
            currentAnalysisText = suggestionsText;
            
            // Show the speak button
            document.getElementById('speakBtn').style.display = 'inline-block';
            
            // Parse the text and format it nicely
            const suggestions = suggestionsText.split('\n').filter(line => 
                line.trim() && (line.includes('•') || line.includes('-') || line.match(/^\d+\./) || line.trim().length > 20)
            );
            
            suggestionsContainer.innerHTML = '';
            
            if (suggestions.length === 0) {
                suggestionsContainer.innerHTML = '<div class="suggestion-item">' + suggestionsText + '</div>';
                return;
            }
            
            suggestions.forEach(suggestion => {
                const cleanSuggestion = suggestion.replace(/^[•\-\d\.\s]+/, '').trim();
                if (cleanSuggestion) {
                    const suggestionElement = document.createElement('div');
                    suggestionElement.className = 'suggestion-item';
                    suggestionElement.textContent = cleanSuggestion;
                    suggestionsContainer.appendChild(suggestionElement);
                }
            });
        }

        // Function to speak the analysis
        function speakAnalysis() {
            const speakBtn = document.getElementById('speakBtn');
            const speakBtnText = document.getElementById('speakBtnText');
            
            // If currently speaking, stop it
            if (speechSynthesis.speaking) {
                speechSynthesis.cancel();
                speakBtnText.innerHTML = 'Play Analysis';
                speakBtn.querySelector('i').className = 'fas fa-volume-up';
                return;
            }
            
            if (!currentAnalysisText) {
                alert('No analysis available to read.');
                return;
            }
            
            // Create a new utterance
            currentUtterance = new SpeechSynthesisUtterance(currentAnalysisText);
            
            // Configure voice settings
            currentUtterance.rate = 0.9; // Slightly slower for medical information
            currentUtterance.pitch = 1;
            currentUtterance.volume = 1;
            
            // Try to use a more natural voice if available
            const voices = speechSynthesis.getVoices();
            const preferredVoice = voices.find(voice => 
                voice.lang.startsWith('en') && (voice.name.includes('Female') || voice.name.includes('Google'))
            );
            if (preferredVoice) {
                currentUtterance.voice = preferredVoice;
            }
            
            // Update button during speech
            currentUtterance.onstart = () => {
                speakBtnText.innerHTML = 'Stop';
                speakBtn.querySelector('i').className = 'fas fa-stop';
            };
            
            currentUtterance.onend = () => {
                speakBtnText.innerHTML = 'Play Analysis';
                speakBtn.querySelector('i').className = 'fas fa-volume-up';
            };
            
            currentUtterance.onerror = (event) => {
                console.error('Speech synthesis error:', event);
                speakBtnText.innerHTML = 'Play Analysis';
                speakBtn.querySelector('i').className = 'fas fa-volume-up';
                alert('Error playing audio. Please try again.');
            };
            
            // Speak the text
            speechSynthesis.speak(currentUtterance);
        }

        // Event listener for speak button
        document.getElementById('speakBtn').addEventListener('click', speakAnalysis);

        // Load voices when they're ready
        if (speechSynthesis.onvoiceschanged !== undefined) {
            speechSynthesis.onvoiceschanged = () => {
                speechSynthesis.getVoices();
            };
        }

        // Event listener for analyze button
        document.getElementById('analyzeBtn').addEventListener('click', async () => {
            if (!currentHealthData.heartRate) {
                alert('Please wait for health data to load first.');
                return;
            }

            const analyzeBtn = document.getElementById('analyzeBtn');
            const originalText = analyzeBtn.innerHTML;
            
            analyzeBtn.innerHTML = '<i class="fas fa-spinner fa-spin" style="margin-right: 0.5rem;"></i>Analyzing...';
            analyzeBtn.disabled = true;

            const suggestionsContainer = document.getElementById('aiSuggestions');
            suggestionsContainer.innerHTML = '<div class="loading">Analyzing your health data with AI...</div>';

            try {
                const analysis = await getHealthAnalysis(currentHealthData);
                displaySuggestions(analysis);
            } catch (error) {
                suggestionsContainer.innerHTML = '<div class="suggestion-item">Error generating suggestions. Please try again.</div>';
            }

            analyzeBtn.innerHTML = originalText;
            analyzeBtn.disabled = false;
        });

        // Auto-analyze when data changes significantly
        let lastAutoAnalysis = 0;
        function autoAnalyzeIfNeeded(newData) {
            const now = Date.now();
            // Auto-analyze every 5 minutes or if metrics change significantly
            if (now - lastAutoAnalysis > 300000 || 
                Math.abs((newData.heartRate || 0) - (currentHealthData.heartRate || 0)) > 10 ||
                Math.abs((newData.spo2 || 0) - (currentHealthData.spo2 || 0)) > 2) {
                
                lastAutoAnalysis = now;
                getHealthAnalysis(newData).then(displaySuggestions);
            }
        }

        // Function to update Google Maps
        function updateMap(latitude, longitude) {
            if (latitude && longitude && latitude !== 0 && longitude !== 0) {
                const mapIframe = document.getElementById('googleMap');
                const mapUrl = `https://maps.google.com/maps?q=${latitude},${longitude}&z=15&output=embed`;
                mapIframe.src = mapUrl;
            }
        }

        // Listen for real-time updates
        onValue(sensorDataRef, (snapshot) => {
            const data = snapshot.val();
            if (!data) {
                console.warn('No data received from Firebase');
                return;
            }

            try {
                const sensorKeys = Object.keys(data);
                const latestKey = sensorKeys[sensorKeys.length - 1];
                const latestData = data[latestKey];

                // Store current data for analysis first
                currentHealthData = { ...latestData };

                // Validate and update heart rate
                const heartRate = Number(latestData.heartRate) || 0;
                const heartRateElement = document.getElementById('heartRateValue');
                const heartRateStatus = document.getElementById('heartRateStatus');
                const heartRateProgress = document.getElementById('heartRateProgress');

                if (isValidHeartRate(heartRate)) {
                    heartRateElement.textContent = `${heartRate} BPM`;
                    
                    // Update heart rate status
                    if (heartRate < 60) {
                        heartRateStatus.textContent = 'Low';
                        heartRateStatus.className = 'card-status status-warning';
                    } else if (heartRate > 100) {
                        heartRateStatus.textContent = 'High';
                        heartRateStatus.className = 'card-status status-critical';
                    } else {
                        heartRateStatus.textContent = 'Normal';
                        heartRateStatus.className = 'card-status status-normal';
                    }
                    
                    // Update progress bar
                    const progress = (heartRate / 200) * 100;
                    heartRateProgress.style.width = `${Math.min(progress, 100)}%`;
                } else {
                    console.warn('Invalid heart rate value:', heartRate);
                    heartRateElement.textContent = 'Error';
                    heartRateStatus.textContent = 'Invalid';
                    heartRateStatus.className = 'card-status status-warning';
                    heartRateProgress.style.width = '0%';
                }

                // Validate and update SpO2
                const spo2 = Number(latestData.spo2) || 0;
                const spo2Valid = Boolean(latestData.spo2Valid);
                const spo2Element = document.getElementById('spo2Value');
                const spo2Status = document.getElementById('spo2Status');
                const spo2Progress = document.getElementById('spo2Progress');

                if (isValidSpO2(spo2) && spo2Valid) {
                    spo2Element.textContent = `${spo2}%`;
                    
                    // Update SpO2 status
                    if (spo2 < 95) {
                        spo2Status.textContent = 'Low';
                        spo2Status.className = 'card-status status-critical';
                    } else if (spo2 < 97) {
                        spo2Status.textContent = 'Fair';
                        spo2Status.className = 'card-status status-warning';
                    } else {
                        spo2Status.textContent = 'Good';
                        spo2Status.className = 'card-status status-normal';
                    }
                    
                    // Update progress bar
                    spo2Progress.style.width = `${spo2}%`;
                } else {
                    console.warn('Invalid SpO2 value:', spo2, 'Valid:', spo2Valid);
                    spo2Element.textContent = 'Error';
                    spo2Status.textContent = 'Invalid Reading';
                    spo2Status.className = 'card-status status-warning';
                    spo2Progress.style.width = '0%';
                }

                // Validate GPS
                const gps = latestData.gps || {};
                if (isValidGPS(gps.latitude, gps.longitude)) {
                    updateMap(gps.latitude, gps.longitude);
                } else {
                    console.warn('Invalid GPS coordinates:', gps);
                    document.getElementById('gpsStatus').textContent = 'Invalid Location Data';
                    document.getElementById('gpsStatus').className = 'card-status status-warning';
                }

                // Update GPS Data
                const gpsData = latestData.gps || {};
                document.getElementById('gpsLatitude').textContent = gpsData.latitude || 'No data';
                document.getElementById('gpsLongitude').textContent = gpsData.longitude || 'No data';
                document.getElementById('gpsSatellites').textContent = gpsData.satellites || '0';
                
                // Update GPS Status and Map
                const gpsStatus = (gpsData.latitude && gpsData.longitude && gpsData.latitude !== 0 && gpsData.longitude !== 0) 
                    ? 'Location Active' 
                    : 'Waiting for GPS';
                document.getElementById('gpsStatus').textContent = gpsStatus;
                document.getElementById('gpsStatus').className = gpsStatus === 'Location Active' 
                    ? 'card-status status-normal' 
                    : 'card-status status-warning';

                // Update Google Maps
                updateMap(gpsData.latitude, gpsData.longitude);

                // Update last update time
                const now = new Date();
                document.getElementById('lastUpdate').textContent = `Last updated: ${now.toLocaleTimeString()}`;

                // Auto-analyze if needed
                autoAnalyzeIfNeeded(latestData);

                console.log('Updated data from Firebase:', latestData);
            } catch (error) {
                console.error('Error processing sensor data:', error);
                showError('Error processing health data');
            }
        }, (error) => {
            console.error('Error reading from Firebase:', error);
            document.getElementById('heartRateStatus').textContent = 'Connection Error';
            document.getElementById('spo2Status').textContent = 'Connection Error';
            document.getElementById('gpsStatus').textContent = 'Connection Error';
        });

        // Add these validation functions after Firebase initialization

        function isValidHeartRate(hr) {
            return typeof hr === 'number' && hr > 0 && hr < 300;
        }

        function isValidSpO2(spo2) {
            return typeof spo2 === 'number' && spo2 >= 0 && spo2 <= 100;
        }

        function isValidGPS(lat, long) {
            return typeof lat === 'number' && 
                   typeof long === 'number' &&
                   lat >= -90 && lat <= 90 && 
                   long >= -180 && long <= 180;
        }

        // Add error display function
        function showError(message) {
            const suggestions = document.getElementById('aiSuggestions');
            suggestions.innerHTML = `<div class="suggestion-item" style="color: #ff6b6b;">${message}</div>`;
        }

        // Add retry mechanism for API calls
        async function retryFetch(url, options, maxRetries = 3) {
            for (let i = 0; i < maxRetries; i++) {
                try {
                    const response = await fetch(url, options);
                    if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                    return await response.json();
                } catch (error) {
                    if (i === maxRetries - 1) throw error;
                    await new Promise(resolve => setTimeout(resolve, 1000 * Math.pow(2, i)));
                }
            }
        }
    </script>
</body>
</html>