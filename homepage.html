<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>LifeLink - Futuristic Healthcare</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --neon-blue: #00c6ff;
            --neon-purple: #7700ff;
            --neon-cyan: #00ffea;
            --dark-bg: #0a0e17;
            --card-bg: #12192e;
            --glow-intensity: 0 0 10px;
        }

        * { margin:0; padding:0; box-sizing:border-box; font-family:'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }

        body {
            background-color: var(--dark-bg);
            color: #fff;
            overflow-x: hidden;
            background-image:
                radial-gradient(circle at 10% 20%, rgba(119, 0, 255, 0.1) 0%, transparent 20%),
                radial-gradient(circle at 90% 80%, rgba(0, 198, 255, 0.1) 0%, transparent 20%);
        }

        /* Header Styles */
        header {
            display:flex;
            justify-content:space-between;
            align-items:center;
            padding:1.5rem 5%;
            background-color: rgba(10,14,23,0.9);
            border-bottom: 1px solid rgba(0,198,255,0.2);
            position: sticky;
            top: 0;
            z-index: 100;
            backdrop-filter: blur(10px);
        }

        .logo { font-size:2rem; font-weight:700;
            background: linear-gradient(45deg, var(--neon-blue), var(--neon-purple));
            -webkit-background-clip: text; background-clip: text; color: transparent;
            text-shadow: var(--glow-intensity) rgba(119,0,255,0.5);
        }

        nav ul { display:flex; list-style:none; gap:2rem; }
        nav a { color:#fff; text-decoration:none; font-weight:500; transition:all 0.3s ease; padding:0.5rem 1rem; border-radius:4px; }
        nav a:hover { color:var(--neon-cyan); text-shadow: var(--glow-intensity) var(--neon-cyan); }

        /* Home Page */
        .home-content {
            display:flex;
            align-items:center;
            min-height: 80vh;
            gap:4rem;
            padding:2rem 5%;
        }

        .home-text { flex:1; }
        .home-title {
            font-size:3.5rem; margin-bottom:1.5rem;
            background: linear-gradient(45deg, var(--neon-blue), var(--neon-purple));
            -webkit-background-clip: text; background-clip: text; color: transparent;
            text-shadow: var(--glow-intensity) rgba(119,0,255,0.5);
        }

        .home-subtitle { font-size:1.2rem; margin-bottom:2rem; color:#a0aec0; line-height:1.6; }

        .btn-container { display:flex; gap:1rem; }
        .btn { padding:1rem 2rem; border-radius:50px; font-weight:600; cursor:pointer; transition:all 0.3s ease; border:none; font-size:1rem; }
        .btn-primary { background: linear-gradient(45deg, var(--neon-blue), var(--neon-purple)); color:#fff; box-shadow:0 0 15px rgba(119,0,255,0.5); }
        .btn:hover { transform: translateY(-3px); box-shadow:0 0 20px rgba(119,0,255,0.7); }

        .home-visual { flex:1; position:relative; perspective:1000px; }
        .hologram-container { width:100%; height:400px; position:relative; transform-style:preserve-3d; animation:float 6s ease-in-out infinite; }
        .hologram { position:absolute; width:300px; height:300px; background: linear-gradient(45deg, rgba(0,198,255,0.2), rgba(119,0,255,0.2)); border-radius:20px; transform: rotateX(60deg) rotateZ(45deg); box-shadow:0 0 50px rgba(0,198,255,0.3); backdrop-filter: blur(5px); border:1px solid rgba(0,198,255,0.3); }
        .hologram-doctor { position:absolute; width:200px; height:300px; background: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 200 300"><path d="M100,50 C120,50 140,70 140,90 C140,110 120,130 100,130 C80,130 60,110 60,90 Z" fill="%23ffffff"/></svg>') center/contain no-repeat; transform: translateZ(40px); filter: drop-shadow(0 0 10px var(--neon-blue)); }
        .hologram-data { position:absolute; width:150px; height:150px; background: rgba(0,198,255,0.1); border-radius:10px; transform: translateZ(80px) translateX(80px) translateY(-40px); box-shadow:0 0 20px rgba(0,198,255,0.4); border:1px solid rgba(0,198,255,0.3); display:flex; justify-content:center; align-items:center; color:var(--neon-cyan); font-size:1.5rem; font-weight:bold; }

        .floating-element { position:absolute; width:100px; height:100px; border-radius:50%; background: linear-gradient(45deg, var(--neon-blue), var(--neon-purple)); opacity:0.2; filter: blur(20px); animation: float 8s ease-in-out infinite; z-index:-1; }
        .element-1{ top:20%; left:5%; width:150px; height:150px; }
        .element-2{ top:60%; right:10%; width:120px; height:120px; }
        .element-3{ bottom:10%; left:20%; width:80px; height:80px; }

        @keyframes float { 0%{ transform: translateY(0) rotate(0deg);} 50%{ transform: translateY(-20px) rotate(10deg);} 100%{ transform: translateY(0) rotate(0deg);} }

        @media (max-width:992px) { .home-content{ flex-direction:column; text-align:center;} .btn-container{ justify-content:center;} .hologram-container{ height:300px;} }
        @media (max-width:768px) { nav ul{ gap:1rem; } .home-title{ font-size:2.5rem; } }

        /* Chatbot Widget styles (scoped) */
        #chatWidget { position:fixed; bottom:24px; right:24px; z-index:9999; font-family:'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        .chat-toggle-btn { width:64px; height:64px; border-radius:50%; background: linear-gradient(135deg,#3498db,#2c3e50); color:#fff; display:flex; align-items:center; justify-content:center; box-shadow:0 8px 20px rgba(0,0,0,0.3); cursor:pointer; border:none; }
        .chat-panel { width:360px; max-width: calc(100vw - 48px); height:520px; background: linear-gradient(180deg,#ffffff,#f6f9fb); border-radius:14px; box-shadow:0 20px 40px rgba(2,6,23,0.5); overflow:hidden; display:flex; flex-direction:column; margin-bottom:12px; }
        .chat-header { padding:12px 14px; background: linear-gradient(90deg,#3498db,#2c3e50); color:#fff; display:flex; align-items:center; justify-content:space-between; }
        .chat-header h3 { font-size:16px; display:flex; align-items:center; gap:8px; margin:0; }
        .chat-close-btn { background:transparent; border:none; color:rgba(255,255,255,0.9); font-size:18px; cursor:pointer; }
        .chat-container-widget { padding:12px; flex:1; overflow-y:auto; display:flex; flex-direction:column; gap:10px; background: linear-gradient(180deg,#fbfdff 0%,#f3f7fb 100%); }
        .message { max-width:80%; padding:10px 12px; border-radius:12px; line-height:1.4; position:relative; animation:fadeIn 0.2s ease; font-size:14px; word-wrap:break-word; white-space:pre-wrap; }
        .bot-message { background-color:#eef6ff; color:#213547; align-self:flex-start; border-bottom-left-radius:6px; }
        .user-message { background: linear-gradient(135deg,#3498db,#2c3e50); color:#fff; align-self:flex-end; border-bottom-right-radius:6px; }
        .input-area-widget { padding:10px; border-top:1px solid #e6eef8; display:flex; gap:8px; align-items:center; background:#fff; }
        .text-input-widget { flex:1; padding:10px 12px; border:1px solid #dbeaf7; border-radius:999px; outline:none; font-size:14px; }
        .send-btn-widget, .upload-btn-widget { width:40px; height:40px; border-radius:50%; border:none; background: linear-gradient(135deg,#3498db,#2c3e50); color:#fff; cursor:pointer; display:inline-flex; align-items:center; justify-content:center; }
        .typing-indicator { display:inline-block; padding:8px 12px; background-color:#eef6ff; border-radius:14px; border-bottom-left-radius:6px; }
        .typing-indicator span { height:6px; width:6px; background-color:#7f8c8d; border-radius:50%; display:inline-block; margin:0 2px; animation:bounce 1.3s linear infinite; }
        @keyframes bounce { 0%,60%,100%{ transform:translateY(0);} 30%{ transform:translateY(-4px);} }
        .upload-modal-widget { display:none; position:fixed; bottom:100px; right:24px; z-index:10000; }
        .upload-popup { width:320px; background:#fff; border-radius:12px; box-shadow:0 10px 30px rgba(0,0,0,0.2); padding:12px; }
        .preview-container { display:flex; gap:8px; margin-top:8px; flex-wrap:wrap; }
        .preview-item { position:relative; width:72px; height:72px; border-radius:8px; overflow:hidden; box-shadow:0 3px 10px rgba(0,0,0,0.08); }
        .preview-item img { width:100%; height:100%; object-fit:cover; }
        .remove-btn { position:absolute; top:4px; right:4px; background:rgba(255,255,255,0.8); border:none; border-radius:50%; width:20px; height:20px; display:flex; align-items:center; justify-content:center; cursor:pointer; font-size:12px; }
        .api-status { font-size:12px; margin-left:8px; display:inline-flex; align-items:center; gap:6px; color:#fff; }

        @media(max-width:480px) {
            .chat-panel { width: calc(100vw - 32px); right:16px; left:16px; height:70vh; }
            #chatWidget { right:12px; bottom:12px; }
        }

        @keyframes fadeIn { from{opacity:0; transform:translateY(6px);} to{opacity:1; transform:translateY(0);} }
        /* hidden canvas */
        #analysisCanvas { display:none; }
    </style>
</head>
<body>
    <!-- Header -->
    <header>
        <div class="logo">LifeLink</div>
        <nav>
            <ul>
                <li><a href="#" class="nav-link">Home</a></li>
                <li><a href="dashboard.html" class="nav-link">Dashboard</a></li>
                <li><a href="reportt.html" class="nav-link">Health Data</a></li>
                <!-- loginNav will be shown only when NOT signed in -->
                <li id="loginNav"><a href="login.html" class="nav-link">Login/Sign-up</a></li>
                <li><a href="profile.html" class="nav-link">Profile</a></li>
                <li><a href="reminder.html" class="nav-link">Reminders</a></li>
                <!-- logoutNav will be shown only when signed in -->
                <li id="logoutNav" style="display:none;"><a href="#" class="nav-link" onclick="logout()">Logout</a></li>
            </ul>
        </nav>
    </header>

    <!-- 3D Floating Elements -->
    <div class="floating-element element-1"></div>
    <div class="floating-element element-2"></div>
    <div class="floating-element element-3"></div>

    <!-- Home Page -->
    <section id="home">
        <div class="home-content">
            <div class="home-text">
                <h1 class="home-title">Connecting Lives, Empowering Health</h1>
                <p class="home-subtitle">Experience the future of healthcare with AI-powered diagnostics, real-time monitoring, and instant emergency support.</p>
                <div class="btn-container">
                    <button class="btn btn-primary">Get Connected</button>
                </div>
            </div>
            <div class="home-visual">
                <div class="hologram-container">
                    <div class="hologram"></div>
                    <div class="hologram-doctor"></div>
                    <div class="hologram-data">98%</div>
                    <div class="hologram-data" style="transform: translateZ(80px) translateX(-80px) translateY(40px);">72 BPM</div>
                </div>
            </div>
        </div>
    </section>

    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>

    <script>
      // Your web app's Firebase configuration (unchanged)
      const firebaseConfig = {
        apiKey: "AIzaSyBdSoee19xeRhejBcvGJRiAIiMEEkS2wKA",
        authDomain: "lifelink-e7e3a.firebaseapp.com",
        projectId: "lifelink-e7e3a",
        storageBucket: "lifelink-e7e3a.firebasestorage.app",
        messagingSenderId: "56154827817",
        appId: "1:56154827817:web:d834413e1dc99f6d124038",
        measurementId: "G-F9S6YWYWCG"
      };
      firebase.initializeApp(firebaseConfig);

      const loginNav = () => document.getElementById('loginNav');
      const logoutNav = () => document.getElementById('logoutNav');
      firebase.auth().onAuthStateChanged((user) => {
        const loginEl = loginNav();
        const logoutEl = logoutNav();
        if (user) {
          if (loginEl) loginEl.style.display = 'none';
          if (logoutEl) logoutEl.style.display = 'inline-block';
        } else {
          if (loginEl) loginEl.style.display = 'inline-block';
          if (logoutEl) logoutEl.style.display = 'none';
        }
      });
      function logout() {
        firebase.auth().signOut().then(() => {
          console.log('User signed out');
          window.location.href = 'login.html';
        }).catch((error) => {
          console.error('Sign Out Error', error);
          alert('Logout failed. Please try again.');
        });
      }
    </script>

    <!-- Chatbot Widget -->
    <div id="chatWidget" aria-live="polite">
        <div id="chatPanelWrapper" style="display:none; flex-direction:column; align-items:flex-end;">
            <div class="chat-panel" role="dialog" aria-label="MediBot chat panel">
                <div class="chat-header">
                    <h3><i class="fas fa-robot"></i> MediBot <span class="api-status" id="apiStatusWidget"><i class="fas fa-check-circle"></i>&nbsp;Local AI</span></h3>
                    <button class="chat-close-btn" id="chatCloseBtn" aria-label="Close chat"><i class="fas fa-times"></i></button>
                </div>

                <div class="chat-container-widget" id="chatContainerWidget" aria-live="polite">
                    <div class="message bot-message">
                        <p>Hello! I'm MediBot, your AI medical assistant. I can help analyze symptoms or images of medical conditions.</p>
                        <p><strong>Note:</strong> This is an AI assistant and not a substitute for professional medical advice.</p>
                    </div>
                </div>

                <div class="input-area-widget">
                    <button class="upload-btn-widget" id="uploadBtnWidget" title="Upload image" aria-label="Upload image"><i class="fas fa-camera"></i></button>
                    <input type="text" class="text-input-widget" id="textInputWidget" placeholder="Describe your symptoms or condition..." aria-label="Type your message" />
                    <button class="send-btn-widget" id="sendBtnWidget" aria-label="Send message"><i class="fas fa-paper-plane"></i></button>
                </div>
            </div>
        </div>

        <button class="chat-toggle-btn" id="chatToggleBtn" aria-label="Open MediBot chat" title="Open MediBot">
            <i class="fas fa-comment-medical" style="font-size:20px;"></i>
        </button>

        <!-- Upload small popup -->
        <div class="upload-modal-widget" id="uploadModalWidget">
            <div class="upload-popup" role="dialog" aria-label="Upload image for analysis">
                <div style="display:flex; justify-content:space-between; align-items:center;">
                    <strong>Upload Image</strong>
                    <button id="closeUploadWidget" style="background:none; border:none; cursor:pointer;"><i class="fas fa-times"></i></button>
                </div>

                <div style="margin-top:8px;">
                    <div style="padding:12px; border:1px dashed #dbeaf7; border-radius:8px; text-align:center; cursor:pointer;" id="uploadAreaWidget">
                        <i class="fas fa-cloud-upload-alt" style="font-size:20px; color:#3498db;"></i>
                        <p style="color:#3498db; margin-top:6px;">Click to browse or drag and drop an image</p>
                        <input type="file" class="file-input-widget" id="fileInputWidget" accept="image/*" style="display:none;" />
                    </div>

                    <div class="preview-container" id="previewContainerWidget"></div>

                    <div style="display:flex; justify-content:flex-end; gap:8px; margin-top:10px;">
                        <button id="cancelUploadWidget" style="padding:8px 12px; border-radius:6px; border:1px solid #ccc; background:#fff;">Cancel</button>
                        <button id="analyzeImageWidget" style="padding:8px 12px; border-radius:6px; background:linear-gradient(135deg,#3498db,#2c3e50); color:#fff; border:none;">Analyze</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Hidden canvas used for lightweight client-side analysis -->
    <canvas id="analysisCanvas" width="512" height="512" aria-hidden="true"></canvas>

    <script>
        // Medical knowledge (from chatbot.html) scoped for the widget (unchanged)
        const medicalKnowledgeWidget = {
            'headache': {
                conditions: ['Tension headache', 'Migraine', 'Sinus headache', 'Cluster headache'],
                recommendations: [
                    'Rest in a quiet, dark room',
                    'Stay hydrated by drinking water',
                    'Apply a cool or warm compress to your forehead',
                    'Practice relaxation techniques like deep breathing',
                    'Consider over-the-counter pain relief if appropriate'
                ],
                warningSigns: [
                    'Sudden, severe headache',
                    'Headache with fever, stiff neck, or confusion',
                    'Headache after head injury',
                    'Headache with vision changes or difficulty speaking'
                ]
            },
            'fever': {
                conditions: ['Viral infection', 'Bacterial infection', 'Inflatory condition'],
                recommendations: [
                    'Rest and get plenty of sleep',
                    'Stay hydrated with water, broth, or electrolyte drinks',
                    'Use a damp cloth to cool the forehead',
                    'Take appropriate fever-reducing medication if needed',
                    'Dress in lightweight clothing'
                ],
                warningSigns: [
                    'Fever over 103°F (39.4°C)',
                    'Fever lasting more than 3 days',
                    'Fever with rash, difficulty breathing, or severe pain',
                    'Fever in infants under 3 months'
                ]
            },
            'cough': {
                conditions: ['Common cold', 'Bronchitis', 'Allergies', 'Asthma', 'Pneumonia'],
                recommendations: [
                    'Get plenty of rest',
                    'Stay hydrated with warm fluids like tea or broth',
                    'Use a humidifier to moisten the air',
                    'Consider honey for cough relief (for adults and children over 1)',
                    'Use saline nasal spray for congestion'
                ],
                warningSigns: [
                    'Difficulty breathing or shortness of breath',
                    'Coughing up blood',
                    'Fever that persists',
                    'Cough lasting more than 3 weeks'
                ]
            },
            'rash': {
                conditions: ['Contact dermatitis', 'Eczema', 'Allergic reaction', 'Viral rash', 'Fungal infection'],
                recommendations: [
                    'Keep the area clean and dry',
                    'Avoid scratching the affected area',
                    'Use mild, fragrance-free soap',
                    'Apply cool compresses to reduce itching',
                    'Consider over-the-counter hydrocortisone cream for itching'
                ],
                warningSigns: [
                    'Rash spreads rapidly',
                    'Rash is painful or shows signs of infection',
                    'Rash accompanied by fever or difficulty breathing',
                    'Rash covers large areas of the body'
                ]
            },
            'stomach': {
                conditions: ['Gastroenteritis', 'Food poisoning', 'Irritable bowel syndrome', 'Indigestion'],
                recommendations: [
                    'Stay hydrated with clear fluids',
                    'Eat bland foods like crackers, toast, or bananas',
                    'Avoid spicy, fatty, or dairy foods',
                    'Get plenty of rest',
                    'Use a heating pad for cramping'
                ],
                warningSigns: [
                    'Severe abdominal pain',
                    'Vomiting blood or blood in stool',
                    'Dehydration symptoms',
                    'Symptoms lasting more than 2 days'
                ]
            }
        };

        // Medical AI (adapted) - analyzeImage accepts structured analysis object
        class MedicalAIWidget {
            generateResponse(symptoms, imageAnalysis = null) {
                if (!symptoms || !symptoms.trim()) {
                    return "Please tell me a bit about what you're experiencing (symptoms, duration, severity) and I'll try to provide helpful guidance.";
                }

                const lowerSymptoms = symptoms.toLowerCase();
                const greetings = ['hi', 'hello', 'hey', 'good morning', 'good afternoon', 'good evening'];
                const casualPhrases = ['how are you', 'what can you do', 'help', 'who are you'];

                if (greetings.some(g => lowerSymptoms.includes(g))) {
                    return "Hello there! I'm MediBot — I can help you understand common symptoms and offer self-care suggestions. Tell me what you're feeling or upload an image if relevant.";
                }

                if (casualPhrases.some(p => lowerSymptoms.includes(p))) {
                    return "I'm MediBot, your friendly medical assistant. You can describe your symptoms, upload a photo of a visible issue, or ask about when to seek medical care.";
                }

                let matchedCondition = null;
                for (const [condition, data] of Object.entries(medicalKnowledgeWidget)) {
                    if (lowerSymptoms.includes(condition)) {
                        matchedCondition = data;
                        break;
                    }
                }

                if (!matchedCondition) {
                    return "I understand you're reaching out about a health concern. I don't have a direct match for that description, but here are some general steps:\n\n• Describe how long you've had symptoms and whether they're getting better or worse.\n• Note any new medications, exposures, or injuries.\n• For sudden severe symptoms (difficulty breathing, high fever, severe pain), seek urgent medical care.\n\nIf you can provide more detail, I can try to suggest possible causes and next steps.";
                }

                let response = `I hear you. Here are some thoughts that might help based on what you described:\n\n`;

                if (imageAnalysis) {
                    // imageAnalysis expected to be an object with keys: severity, redPercent, notes
                    response += `Image analysis:\n• Estimated redness area: ${imageAnalysis.redPercent.toFixed(1)}% of visible area\n• Estimated severity: ${imageAnalysis.severity}\n`;
                    if (imageAnalysis.notes && imageAnalysis.notes.length) {
                        response += `• Notes: ${imageAnalysis.notes.join('; ')}\n`;
                    }
                    response += `\n`;
                }

                response += `Possible related conditions: ${matchedCondition.conditions.slice(0,3).join(', ')}.\n\n`;
                response += `Recommendations:\n`;
                matchedCondition.recommendations.forEach(rec => { response += `• ${rec}\n`; });

                response += `\nWhen to seek medical attention:\n`;
                matchedCondition.warningSigns.forEach(sign => { response += `• ${sign}\n`; });

                response += `\nIf you'd like, you can upload a photo (if applicable) or tell me more specifics about your symptoms.`;

                return response;
            }

            // fallback analyzeImage kept for compatibility but not used when we have client-side metrics
            analyzeImage() {
                const analyses = [
                    "I can see the area you're concerned about — it may benefit from a professional evaluation. Keep it clean and monitor for changes.",
                    "This pattern can be seen in inflammatory or allergic skin reactions. A clinician or dermatologist can give a definitive diagnosis.",
                    "The image shows signs that suggest a common skin issue, but a formal diagnosis requires in-person assessment.",
                    "From the image, it looks like something treatable; still, please get a healthcare opinion for confirmation.",
                    "It’s understandable to be concerned — many such conditions are manageable, but please consult a professional for a precise diagnosis."
                ];
                return analyses[Math.floor(Math.random() * analyses.length)];
            }
        }

        // Client-side image analysis helper
        // Lightweight heuristic: compute fraction of strongly red pixels and overall average redness.
        function analyzeImageClientSide(file) {
            return new Promise((resolve, reject) => {
                if (!file) return reject(new Error('No file provided'));
                const img = new Image();
                const url = URL.createObjectURL(file);
                img.onload = () => {
                    try {
                        const canvas = document.getElementById('analysisCanvas');
                        const ctx = canvas.getContext('2d');

                        // Resize preserving aspect ratio, max dimension 512
                        const maxDim = 512;
                        let w = img.width;
                        let h = img.height;
                        if (w > h) {
                            if (w > maxDim) {
                                h = Math.round(h * (maxDim / w));
                                w = maxDim;
                            }
                        } else {
                            if (h > maxDim) {
                                w = Math.round(w * (maxDim / h));
                                h = maxDim;
                            }
                        }
                        canvas.width = w;
                        canvas.height = h;
                        ctx.clearRect(0, 0, w, h);
                        ctx.drawImage(img, 0, 0, w, h);

                        const imageData = ctx.getImageData(0, 0, w, h);
                        const data = imageData.data;
                        let redCount = 0;
                        let totalPixels = w * h;
                        let redSum = 0;
                        let brightCount = 0;

                        // thresholds tuned for typical skin photos but not clinical-grade
                        const RED_DIFF_THRESHOLD = 30; // red is this much higher than max(g,b)
                        const MIN_RED_INTENSITY = 80; // red channel value minimum to count

                        for (let i = 0; i < data.length; i += 4) {
                            const r = data[i];
                            const g = data[i+1];
                            const b = data[i+2];
                            const alpha = data[i+3];
                            if (alpha < 100) { totalPixels--; continue; } // ignore transparent
                            const maxGB = Math.max(g,b);
                            const redDiff = r - maxGB;
                            if (r >= MIN_RED_INTENSITY && redDiff >= RED_DIFF_THRESHOLD) {
                                redCount++;
                                redSum += redDiff;
                            }
                            // quick brightness check
                            const brightness = 0.299*r + 0.587*g + 0.114*b;
                            if (brightness > 200) brightCount++;
                        }

                        const redPercent = totalPixels > 0 ? (redCount / totalPixels) * 100 : 0;
                        const avgRedDiff = redCount > 0 ? (redSum / redCount) : 0;
                        const brightAreaPercent = totalPixels > 0 ? (brightCount / totalPixels) * 100 : 0;

                        // classify severity in simple tiers
                        let severity = 'none/minimal';
                        if (redPercent > 8 || avgRedDiff > 70) severity = 'severe';
                        else if (redPercent > 3 || avgRedDiff > 40) severity = 'moderate';
                        else if (redPercent > 0.5 || avgRedDiff > 20) severity = 'mild';

                        const notes = [];
                        if (brightAreaPercent > 30) notes.push('Image has many bright areas — lighting may affect color interpretation');
                        if (redPercent < 0.2 && avgRedDiff < 15) notes.push('No significant redness detected');
                        if (redPercent >= 0.2 && redPercent < 3) notes.push('Small localized red area detected');
                        if (redPercent >= 3 && redPercent < 8) notes.push('Moderate red/inflamed area detected');
                        if (redPercent >= 8) notes.push('Large red/inflamed area detected; consider evaluating for infection or widespread inflammation');

                        // cleanup
                        URL.revokeObjectURL(url);

                        resolve({
                            redPercent,
                            avgRedDiff,
                            brightAreaPercent,
                            severity,
                            notes
                        });
                    } catch (err) {
                        URL.revokeObjectURL(url);
                        reject(err);
                    }
                };
                img.onerror = (e) => {
                    URL.revokeObjectURL(url);
                    reject(new Error('Failed to load image'));
                };
                img.src = url;
            });
        }

        // Widget behavior wiring
        document.addEventListener('DOMContentLoaded', () => {
            const chatToggleBtn = document.getElementById('chatToggleBtn');
            const chatPanelWrapper = document.getElementById('chatPanelWrapper');
            const chatCloseBtn = document.getElementById('chatCloseBtn');
            const chatContainer = document.getElementById('chatContainerWidget');
            const textInput = document.getElementById('textInputWidget');
            const sendBtn = document.getElementById('sendBtnWidget');
            const uploadBtn = document.getElementById('uploadBtnWidget');
            const uploadModal = document.getElementById('uploadModalWidget');
            const closeUpload = document.getElementById('closeUploadWidget');
            const cancelUpload = document.getElementById('cancelUploadWidget');
            const uploadArea = document.getElementById('uploadAreaWidget');
            const fileInput = document.getElementById('fileInputWidget');
            const previewContainer = document.getElementById('previewContainerWidget');
            const analyzeImageBtn = document.getElementById('analyzeImageWidget');
            const apiStatus = document.getElementById('apiStatusWidget');

            const ai = new MedicalAIWidget();
            let uploadedImage = null;

            // Toggle open/close
            chatToggleBtn.addEventListener('click', () => {
                const isOpen = chatPanelWrapper.style.display === 'flex';
                chatPanelWrapper.style.display = isOpen ? 'none' : 'flex';
                if (!isOpen) setTimeout(()=> textInput.focus(), 200);
            });
            chatCloseBtn.addEventListener('click', () => chatPanelWrapper.style.display = 'none');

            // Send message handlers
            sendBtn.addEventListener('click', sendMessage);
            textInput.addEventListener('keypress', (e) => { if (e.key === 'Enter') sendMessage(); });

            function sendMessage() {
                const message = textInput.value.trim();
                if (!message) return;
                addUserMessage(message);
                textInput.value = '';

                const typing = document.createElement('div');
                typing.className = 'message bot-message typing-indicator';
                typing.innerHTML = '<span></span><span></span><span></span>';
                chatContainer.appendChild(typing);
                chatContainer.scrollTop = chatContainer.scrollHeight;

                setTimeout(() => {
                    if (typing.parentElement) typing.parentElement.removeChild(typing);
                    const response = ai.generateResponse(message);
                    addBotMessage(response);
                }, 800 + Math.random()*800);
            }

            function addUserMessage(message) {
                const d = document.createElement('div');
                d.className = 'message user-message';
                d.textContent = message;
                chatContainer.appendChild(d);
                chatContainer.scrollTop = chatContainer.scrollHeight;
            }

            function addBotMessage(message) {
                const d = document.createElement('div');
                d.className = 'message bot-message';
                d.innerHTML = escapeHtml(message).replace(/\n/g, '<br>');
                chatContainer.appendChild(d);
                chatContainer.scrollTop = chatContainer.scrollHeight;
            }

            // Upload flow
            uploadBtn.addEventListener('click', () => { uploadModal.style.display = 'block'; });
            closeUpload.addEventListener('click', () => { uploadModal.style.display = 'none'; clearUploaded(); });
            cancelUpload.addEventListener('click', () => { uploadModal.style.display = 'none'; clearUploaded(); });

            uploadArea.addEventListener('click', () => fileInput.click());
            uploadArea.addEventListener('dragover', (e) => { e.preventDefault(); uploadArea.style.borderColor = '#3498db'; });
            uploadArea.addEventListener('dragleave', (e) => { e.preventDefault(); uploadArea.style.borderColor = ''; });
            uploadArea.addEventListener('drop', (e) => {
                e.preventDefault();
                uploadArea.style.borderColor = '';
                const file = e.dataTransfer.files[0];
                handleFile(file);
            });
            fileInput.addEventListener('change', (e) => {
                const file = e.target.files[0];
                handleFile(file);
            });

            function handleFile(file) {
                if (file && file.type.startsWith('image/')) {
                    uploadedImage = file;
                    const reader = new FileReader();
                    reader.onload = (ev) => {
                        previewContainer.innerHTML = '';
                        const previewItem = document.createElement('div');
                        previewItem.className = 'preview-item';
                        const img = document.createElement('img');
                        img.src = ev.target.result;
                        const removeBtn = document.createElement('button');
                        removeBtn.className = 'remove-btn';
                        removeBtn.innerHTML = '&times;';
                        removeBtn.addEventListener('click', () => { previewContainer.innerHTML = ''; uploadedImage = null; fileInput.value = ''; });
                        previewItem.appendChild(img);
                        previewItem.appendChild(removeBtn);
                        previewContainer.appendChild(previewItem);
                    };
                    reader.readAsDataURL(file);
                } else {
                    alert('Please select a valid image file.');
                }
            }

            analyzeImageBtn.addEventListener('click', async () => {
                if (!uploadedImage) {
                    alert('Please select an image first.');
                    return;
                }
                // UX: close modal and show uploading message
                uploadModal.style.display = 'none';
                addUserMessage("Image uploaded for analysis");

                const typing = document.createElement('div');
                typing.className = 'message bot-message typing-indicator';
                typing.innerHTML = '<span></span><span></span><span></span>';
                chatContainer.appendChild(typing);
                chatContainer.scrollTop = chatContainer.scrollHeight;

                try {
                    // perform client-side analysis
                    const metrics = await analyzeImageClientSide(uploadedImage);

                    // build a clear, clinical-seeming response from metrics
                    if (typing.parentElement) typing.parentElement.removeChild(typing);

                    const imageInsight = `Detected redness covering approximately ${metrics.redPercent.toFixed(1)}% of the visible area. ` +
                        `Estimated severity: ${metrics.severity}. ${metrics.notes.join('; ')}`;

                    // Use the main generator to include the result with symptom info (if user had typed text earlier)
                    const response = `${imageInsight}\n\nHere's what I'd suggest:\n• Keep the area clean and dry\n• Avoid touching or scratching it\n• Monitor for spreading, increasing pain, warmth, or pus\n\nDisclaimer: This is an automated image analysis (not a medical diagnosis). For accurate diagnosis, consult a healthcare professional.`;

                    addBotMessage(response);
                    clearUploaded();
                } catch (err) {
                    if (typing.parentElement) typing.parentElement.removeChild(typing);
                    console.error('Image analysis failed', err);
                    addBotMessage("Sorry, I couldn't analyze the image. Please try a different photo or ensure it's well-lit and focused.");
                    clearUploaded();
                }
            });

            function clearUploaded() { uploadedImage = null; previewContainer.innerHTML = ''; fileInput.value = ''; }

            // Escape HTML to avoid injection in messages
            function escapeHtml(unsafe) {
                return (unsafe + '')
                    .replace(/&/g, "&amp;")
                    .replace(/</g, "&lt;")
                    .replace(/>/g, "&gt;")
                    .replace(/"/g, "&quot;")
                    .replace(/'/g, "&#039;");
            }

            // initial helpful tip
            setTimeout(() => {
                addBotMessage("To get started, you can:\n\n1. Describe your symptoms in detail\n2. Upload an image of a skin condition, injury, or other visible issue\n3. Ask questions about self-care or when to seek medical attention");
            }, 800);
        });
    </script>
</body>
</html>