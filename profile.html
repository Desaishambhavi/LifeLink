<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HealthTech | My Profile</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Import Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>
    <style>
        :root {
            --neon-blue: #00c6ff;
            --neon-purple: #7700ff;
            --neon-cyan: #00ffea;
            --dark-bg: #0a0e17;
            --card-bg: #12192e;
            --glow-intensity: 0 0 10px;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background-color: var(--dark-bg);
            color: white;
            min-height: 100vh;
            background-image: 
                radial-gradient(circle at 10% 20%, rgba(0, 198, 255, 0.05) 0%, transparent 20%),
                radial-gradient(circle at 90% 80%, rgba(119, 0, 255, 0.05) 0%, transparent 20%);
            overflow-x: hidden;
            padding: 0;
        }

        .navbar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px 40px;
            background: rgba(18, 25, 46, 0.9);
            backdrop-filter: blur(10px);
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .logo {
            font-size: 24px;
            font-weight: 700;
        }

        .logo span {
            color: var(--neon-cyan);
        }

        .nav-links {
            display: flex;
            gap: 30px;
        }

        .nav-links a {
            color: white;
            text-decoration: none;
            font-weight: 500;
            transition: color 0.3s ease;
            position: relative;
            padding: 8px 0;
        }

        .nav-links a:hover {
            color: var(--neon-cyan);
        }

        .nav-links a.active::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            height: 2px;
            background: linear-gradient(to right, var(--neon-blue), var(--neon-cyan));
        }

        .main-content {
            max-width: 1200px;
            margin: 0 auto;
            padding: 40px;
        }

        .profile-section {
            display: grid;
            grid-template-columns: 300px 1fr;
            gap: 30px;
            margin-bottom: 40px;
        }

        .profile-card {
            background: var(--card-bg);
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .profile-header {
            text-align: center;
            margin-bottom: 25px;
        }

        .avatar {
            width: 100px;
            height: 100px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--neon-purple), var(--neon-blue));
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 20px;
            font-size: 35px;
            color: white;
            border: 3px solid rgba(255, 255, 255, 0.2);
        }

        .profile-header h2 {
            font-size: 24px;
            margin-bottom: 5px;
            background: linear-gradient(to right, var(--neon-blue), var(--neon-cyan));
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
        }

        .profile-header p {
            color: #a0a0a0;
            font-size: 14px;
        }

        .profile-info {
            margin-bottom: 25px;
        }

        .info-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 15px;
            padding-bottom: 15px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .info-label {
            color: #a0a0a0;
            font-weight: 500;
            font-size: 14px;
        }

        .info-value {
            font-weight: 600;
            text-align: right;
        }

        .logout-btn {
            width: 100%;
            padding: 12px;
            background: linear-gradient(to right, var(--neon-purple), var(--neon-blue));
            border: none;
            border-radius: 10px;
            color: white;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(119, 0, 255, 0.3);
        }

        .logout-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(119, 0, 255, 0.4);
        }

        .health-section {
            background: var(--card-bg);
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
        }

        .section-header h2 {
            font-size: 24px;
            background: linear-gradient(to right, var(--neon-blue), var(--neon-cyan));
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
        }

        .last-update {
            color: #a0a0a0;
            font-size: 14px;
        }

        .health-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
        }

        .health-card {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 15px;
            padding: 25px;
            text-align: center;
            border: 1px solid rgba(255, 255, 255, 0.1);
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .health-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: linear-gradient(to right, var(--neon-purple), var(--neon-blue));
        }

        .health-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 30px rgba(0, 198, 255, 0.2);
        }

        .health-icon {
            font-size: 40px;
            margin-bottom: 15px;
            color: var(--neon-cyan);
        }

        .health-value {
            font-size: 42px;
            font-weight: 700;
            margin-bottom: 5px;
            background: linear-gradient(to right, var(--neon-blue), var(--neon-cyan));
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
        }

        .health-label {
            color: #a0a0a0;
            font-size: 16px;
            margin-bottom: 10px;
        }

        .health-status {
            font-size: 13px;
            padding: 6px 12px;
            border-radius: 15px;
            display: inline-block;
            font-weight: 600;
        }

        .status-normal {
            background-color: rgba(0, 255, 0, 0.1);
            color: #6bff6b;
            border: 1px solid rgba(0, 255, 0, 0.3);
        }

        .status-warning {
            background-color: rgba(255, 165, 0, 0.1);
            color: #ffa500;
            border: 1px solid rgba(255, 165, 0, 0.3);
        }

        .status-critical {
            background-color: rgba(255, 0, 0, 0.1);
            color: #ff6b6b;
            border: 1px solid rgba(255, 0, 0, 0.3);
        }

        .health-meta {
            font-size: 12px;
            color: #888;
            margin-top: 8px;
        }

        .message {
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            text-align: center;
            display: none;
        }

        .error {
            background-color: rgba(255, 0, 0, 0.1);
            border: 1px solid rgba(255, 0, 0, 0.3);
            color: #ff6b6b;
        }

        .success {
            background-color: rgba(0, 255, 0, 0.1);
            border: 1px solid rgba(0, 255, 0, 0.3);
            color: #6bff6b;
        }

        .info {
            background-color: rgba(0, 198, 255, 0.1);
            border: 1px solid rgba(0, 198, 255, 0.3);
            color: var(--neon-cyan);
        }

        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255,255,255,.3);
            border-radius: 50%;
            border-top-color: #fff;
            animation: spin 1s ease-in-out infinite;
            margin-right: 10px;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        @media (max-width: 900px) {
            .profile-section {
                grid-template-columns: 1fr;
            }
            
            .navbar {
                padding: 15px 20px;
                flex-direction: column;
                gap: 15px;
            }
            
            .nav-links {
                gap: 20px;
            }
            
            .main-content {
                padding: 20px;
            }
        }

        @media (max-width: 600px) {
            .health-grid {
                grid-template-columns: 1fr;
            }
            
            .nav-links {
                flex-wrap: wrap;
                justify-content: center;
                gap: 15px;
            }
            
            .profile-card, .health-section {
                padding: 20px;
            }
        }
    </style>
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar">
        <div class="logo">Health<span>Tech</span></div>
        <div class="nav-links">
            <a href="homepage.html">Home</a>
            <a href="healthdata.html">Health Data</a>
            <a href="dashboard.html">Dashboard</a>
        </div>
    </nav>

    <!-- Main Content -->
    <div class="main-content">
        <div id="message" class="message info">
            <div class="loading"></div> Loading health data...
        </div>

        <div class="profile-section">
            <!-- Profile Card -->
            <div class="profile-card">
                <div class="profile-header">
                    <div class="avatar" id="userAvatar">
                        <i class="fas fa-user"></i>
                    </div>
                    <h2 id="userFullName">My Profile</h2>
                    <p>HealthTech User</p>
                </div>

                <div class="profile-info">
                    <div class="info-item">
                        <span class="info-label">First Name:</span>
                        <span class="info-value" id="firstName">Loading...</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">Last Name:</span>
                        <span class="info-value" id="lastName">Loading...</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">Email:</span>
                        <span class="info-value" id="userEmail">Loading...</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">User ID:</span>
                        <span class="info-value" id="userId">Loading...</span>
                    </div>
                </div>

                <button class="logout-btn" id="logoutBtn">
                    <i class="fas fa-sign-out-alt"></i> Logout
                </button>
            </div>

            <!-- Health Data Section -->
            <div class="health-section">
                <div class="section-header">
                    <h2>Health Monitoring</h2>
                    <div class="last-update" id="lastUpdateTime">Last update: --</div>
                </div>

                <div class="health-grid">
                    <div class="health-card">
                        <div class="health-icon">
                            <i class="fas fa-heartbeat"></i>
                        </div>
                        <div class="health-value" id="heartRate">--</div>
                        <div class="health-label">Heart Rate</div>
                        <div class="health-status status-normal" id="heartStatus">BPM</div>
                        <div class="health-meta" id="heartUpdated">Updated: --</div>
                    </div>

                    <div class="health-card">
                        <div class="health-icon">
                            <i class="fas fa-lungs"></i>
                        </div>
                        <div class="health-value" id="oxygenLevel">--</div>
                        <div class="health-label">Oxygen Level</div>
                        <div class="health-status status-normal" id="oxygenStatus">SpO2 %</div>
                        <div class="health-meta" id="oxygenUpdated">Updated: --</div>
                    </div>

                    <div class="health-card">
                        <div class="health-icon">
                            <i class="fas fa-walking"></i>
                        </div>
                        <div class="health-value" id="stepsCount">--</div>
                        <div class="health-label">Daily Steps</div>
                        <div class="health-status status-normal" id="stepsStatus">Steps</div>
                        <div class="health-meta">Target: 10,000</div>
                    </div>

                    <div class="health-card">
                        <div class="health-icon">
                            <i class="fas fa-bed"></i>
                        </div>
                        <div class="health-value" id="sleepHours">--</div>
                        <div class="health-label">Sleep</div>
                        <div class="health-status status-normal">Hours</div>
                        <div class="health-meta">Last night</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyBdSoee19xeRhejBcvGJRiAIiMEEkS2wKA",
            authDomain: "lifelink-e7e3a.firebaseapp.com",
            databaseURL: "https://lifelink-e7e3a-default-rtdb.firebaseio.com",
            projectId: "lifelink-e7e3a",
            storageBucket: "lifelink-e7e3a.firebasestorage.app",
            messagingSenderId: "56154827817",
            appId: "1:56154827817:web:d834413e1dc99f6d124038",
            measurementId: "G-F9S6YWYWCG"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();
        const rtdb = firebase.database();

        // DOM elements
        const messageDiv = document.getElementById('message');
        const logoutBtn = document.getElementById('logoutBtn');
        const userAvatar = document.getElementById('userAvatar');
        const userFullName = document.getElementById('userFullName');
        const firstName = document.getElementById('firstName');
        const lastName = document.getElementById('lastName');
        const userEmail = document.getElementById('userEmail');
        const userId = document.getElementById('userId');
        const heartRate = document.getElementById('heartRate');
        const oxygenLevel = document.getElementById('oxygenLevel');
        const heartStatus = document.getElementById('heartStatus');
        const oxygenStatus = document.getElementById('oxygenStatus');
        const heartUpdated = document.getElementById('heartUpdated');
        const oxygenUpdated = document.getElementById('oxygenUpdated');
        const lastUpdateTime = document.getElementById('lastUpdateTime');
        const stepsCount = document.getElementById('stepsCount');
        const stepsStatus = document.getElementById('stepsStatus');
        const sleepHours = document.getElementById('sleepHours');

        // Step Counter Algorithm with IMU and Heart Rate Integration
        class StepCounter {
            constructor() {
                // Configuration parameters based on research
                this.STEP_THRESHOLD = 1.2;           // Minimum acceleration magnitude (g) - typical walking
                this.MIN_STEP_INTERVAL = 300;        // Min time between steps (ms) - max 3.33 steps/sec
                this.MAX_STEP_INTERVAL = 2000;       // Max time between steps (ms) - min 0.5 steps/sec
                this.WINDOW_SIZE = 5;                // Moving average window size
                this.PEAK_THRESHOLD = 0.3;           // Minimum peak prominence (g)
                this.LOW_PASS_ALPHA = 0.8;           // Low-pass filter coefficient
                
                // State variables
                this.stepCount = 0;
                this.lastStepTime = 0;
                this.accelBuffer = [];
                this.peakBuffer = [];
                this.lastPeakValue = 0;
                this.dailyStartTime = this.getTodayStart();
                
                // Heart rate correlation
                this.baselineHR = 70;
                this.currentHR = 70;
                this.lastAccelMagnitude = 1.0;
                
                // Calibration
                this.gravityOffset = 1.0;  // Standard gravity (1g)
                
                this.loadDailySteps();
            }
            
            getTodayStart() {
                const now = new Date();
                now.setHours(0, 0, 0, 0);
                return now.getTime();
            }
            
            // Calculate acceleration magnitude from IMU data (resultant vector)
            calculateMagnitude(accelX, accelY, accelZ) {
                // Convert to m/sÂ² if needed and calculate magnitude
                const magnitude = Math.sqrt(
                    accelX * accelX + 
                    accelY * accelY + 
                    accelZ * accelZ
                );
                return magnitude;
            }
            
            // Remove gravity component and apply low-pass filter
            filterAcceleration(rawMagnitude) {
                // Low-pass filter to smooth the signal
                const filtered = this.LOW_PASS_ALPHA * rawMagnitude + 
                                (1 - this.LOW_PASS_ALPHA) * this.lastAccelMagnitude;
                this.lastAccelMagnitude = filtered;
                
                // Remove gravity component
                return Math.abs(filtered - this.gravityOffset);
            }
            
            // Apply moving average filter for additional noise reduction
            smoothData(value) {
                this.accelBuffer.push(value);
                if (this.accelBuffer.length > this.WINDOW_SIZE) {
                    this.accelBuffer.shift();
                }
                
                const sum = this.accelBuffer.reduce((a, b) => a + b, 0);
                return sum / this.accelBuffer.length;
            }
            
            // Detect if current value is a significant peak
            isPeak(currentValue, previousValue, nextValue) {
                // Check if it's a local maximum
                const isLocalMax = currentValue > previousValue && currentValue > nextValue;
                
                // Check if it exceeds threshold
                const exceedsThreshold = currentValue > this.STEP_THRESHOLD;
                
                // Check peak prominence (difference from valleys)
                const minValley = Math.min(previousValue, nextValue);
                const prominence = currentValue - minValley;
                const hasProminence = prominence > this.PEAK_THRESHOLD;
                
                return isLocalMax && exceedsThreshold && hasProminence;
            }
            
            // Validate step based on timing and heart rate correlation
            isValidStep(currentTime) {
                const timeSinceLastStep = currentTime - this.lastStepTime;
                
                // First step is always valid
                if (this.lastStepTime === 0) {
                    return true;
                }
                
                // Check minimum interval to avoid double counting
                if (timeSinceLastStep < this.MIN_STEP_INTERVAL) {
                    return false;
                }
                
                // Check maximum interval to ensure continuous walking
                if (timeSinceLastStep > this.MAX_STEP_INTERVAL) {
                    return true; // Allow after long pause
                }
                
                // Adjust thresholds based on heart rate
                // Higher HR suggests faster movement (running/jogging)
                // Expected cadence increases with heart rate
                const hrFactor = this.currentHR / this.baselineHR;
                const adjustedMinInterval = this.MIN_STEP_INTERVAL / Math.max(hrFactor, 0.8);
                const adjustedMaxInterval = this.MAX_STEP_INTERVAL / Math.min(hrFactor, 1.5);
                
                return timeSinceLastStep >= adjustedMinInterval && 
                       timeSinceLastStep <= adjustedMaxInterval;
            }
            
            // Calculate expected cadence from heart rate (steps per minute)
            getExpectedCadence() {
                // Research shows correlation between HR and cadence
                // Resting: ~60-80 BPM, ~0 steps/min
                // Walking: ~90-110 BPM, ~90-120 steps/min
                // Jogging: ~120-150 BPM, ~150-180 steps/min
                // Running: ~150+ BPM, ~180+ steps/min
                
                if (this.currentHR < 80) {
                    return 0; // Resting
                } else if (this.currentHR < 110) {
                    return 90 + (this.currentHR - 80) * 1.0; // Walking
                } else if (this.currentHR < 150) {
                    return 120 + (this.currentHR - 110) * 1.5; // Jogging
                } else {
                    return 180 + (this.currentHR - 150) * 0.5; // Running
                }
            }
            
            // Main processing function - processes IMU data and detects steps
            processIMUData(accelX, accelY, accelZ, timestamp, heartRate) {
                // Update heart rate for cadence adjustment
                if (heartRate && heartRate > 40 && heartRate < 220) {
                    this.currentHR = heartRate;
                }
                
                // Calculate raw acceleration magnitude
                const rawMagnitude = this.calculateMagnitude(accelX, accelY, accelZ);
                
                // Filter and remove gravity
                const filteredMagnitude = this.filterAcceleration(rawMagnitude);
                
                // Apply smoothing
                const smoothedMagnitude = this.smoothData(filteredMagnitude);
                
                // Store for peak detection (need 3 consecutive points)
                this.peakBuffer.push(smoothedMagnitude);
                if (this.peakBuffer.length > 3) {
                    this.peakBuffer.shift();
                }
                
                // Need at least 3 points for peak detection
                if (this.peakBuffer.length === 3) {
                    const isPeakDetected = this.isPeak(
                        this.peakBuffer[1],  // Current (middle point)
                        this.peakBuffer[0],  // Previous
                        this.peakBuffer[2]   // Next
                    );
                    
                    // If peak detected, validate with timing and HR
                    if (isPeakDetected && this.isValidStep(timestamp)) {
                        this.stepCount++;
                        this.lastStepTime = timestamp;
                        this.lastPeakValue = this.peakBuffer[1];
                        this.saveDailySteps();
                        
                        console.log(`âœ“ Step detected! Count: ${this.stepCount}, HR: ${this.currentHR}, Accel: ${smoothedMagnitude.toFixed(2)}g`);
                        return true;
                    }
                }
                
                return false;
            }
            
            // Reset counter at midnight
            checkDailyReset() {
                const currentDayStart = this.getTodayStart();
                if (currentDayStart > this.dailyStartTime) {
                    console.log('Daily reset triggered - new day started');
                    this.stepCount = 0;
                    this.dailyStartTime = currentDayStart;
                    this.lastStepTime = 0;
                    this.saveDailySteps();
                }
            }
            
            // Save step count to Firebase
            saveDailySteps() {
                const currentUser = auth.currentUser;
                if (currentUser) {
                    const stepData = {
                        steps: this.stepCount,
                        date: new Date().toISOString().split('T')[0],
                        timestamp: Date.now(),
                        heartRate: this.currentHR
                    };
                    
                    rtdb.ref(`users/${currentUser.uid}/steps/daily`).set(stepData)
                        .catch(error => console.error('Error saving steps:', error));
                }
            }
            
            // Load saved step count for today
            async loadDailySteps() {
                const currentUser = auth.currentUser;
                if (currentUser) {
                    try {
                        const snapshot = await rtdb.ref(`users/${currentUser.uid}/steps/daily`).once('value');
                        const data = snapshot.val();
                        
                        const today = new Date().toISOString().split('T')[0];
                        if (data && data.date === today) {
                            this.stepCount = data.steps || 0;
                            console.log(`Loaded ${this.stepCount} steps from storage`);
                        } else {
                            this.stepCount = 0;
                            console.log('Starting fresh step count for today');
                        }
                    } catch (error) {
                        console.error('Error loading steps:', error);
                        this.stepCount = 0;
                    }
                }
            }
            
            getStepCount() {
                return this.stepCount;
            }
            
            // Get activity level classification based on daily steps
            getActivityLevel() {
                if (this.stepCount < 3000) return 'Sedentary';
                if (this.stepCount < 5000) return 'Low Active';
                if (this.stepCount < 7500) return 'Moderate';
                if (this.stepCount < 10000) return 'Active';
                return 'Very Active';
            }
            
            // Get calories burned estimation (rough estimate)
            getCaloriesBurned() {
                // Average: 0.04 calories per step (varies by weight and intensity)
                return Math.round(this.stepCount * 0.04);
            }
            
            // Get distance traveled in km (rough estimate)
            getDistance() {
                // Average step length: 0.75 meters
                return (this.stepCount * 0.75 / 1000).toFixed(2);
            }
        }

        // Initialize step counter
        const stepCounter = new StepCounter();

        // Show message function
        function showMessage(message, type) {
            messageDiv.innerHTML = type === 'info' ? 
                `<div class="loading"></div> ${message}` : 
                message;
            messageDiv.className = 'message ' + type;
            messageDiv.style.display = 'block';
            
            if (type !== 'info') {
                setTimeout(() => {
                    messageDiv.style.display = 'none';
                }, 5000);
            }
        }

        // Format timestamp
        function formatTimestamp(timestamp) {
            if (!timestamp) return 'Never';
            
            const date = new Date(timestamp);
            const now = new Date();
            const diffMs = now - date;
            const diffMins = Math.floor(diffMs / 60000);
            const diffHours = Math.floor(diffMs / 3600000);
            
            if (diffMins < 1) return 'Just now';
            if (diffMins < 60) return `${diffMins} minutes ago`;
            if (diffHours < 24) return `${diffHours} hours ago`;
            
            return date.toLocaleDateString() + ' ' + date.toLocaleTimeString();
        }

        // Update health status indicators
        function updateHealthStatus(heartValue, oxygenValue) {
            // Heart rate status
            if (heartValue < 60) {
                heartStatus.textContent = 'Low';
                heartStatus.className = 'health-status status-warning';
            } else if (heartValue > 100) {
                heartStatus.textContent = 'High';
                heartStatus.className = 'health-status status-critical';
            } else {
                heartStatus.textContent = 'Normal';
                heartStatus.className = 'health-status status-normal';
            }

            // Oxygen level status
            if (oxygenValue < 90) {
                oxygenStatus.textContent = 'Low';
                oxygenStatus.className = 'health-status status-critical';
            } else if (oxygenValue < 97) {
                oxygenStatus.textContent = 'Fair';
                oxygenStatus.className = 'health-status status-warning';
            } else {
                oxygenStatus.textContent = 'Good';
                oxygenStatus.className = 'health-status status-normal';
            }
        }

        // Update step status based on activity level
        function updateStepStatus(steps) {
            const activityLevel = stepCounter.getActivityLevel();
            stepsStatus.textContent = activityLevel;
            
            if (steps < 5000) {
                stepsStatus.className = 'health-status status-warning';
            } else if (steps < 10000) {
                stepsStatus.className = 'health-status status-normal';
            } else {
                stepsStatus.className = 'health-status status-normal';
            }
        }

        // Get latest sensor data from Firebase
        async function getLatestSensorData() {
            try {
                console.log('Fetching latest sensor data from sensorData path...');
                
                const sensorDataRef = rtdb.ref('sensorData');
                const snapshot = await sensorDataRef.once('value');
                const data = snapshot.val();
                
                if (data) {
                    const sensorKeys = Object.keys(data);
                    const latestKey = sensorKeys[sensorKeys.length - 1];
                    const latestData = data[latestKey];
                    
                    console.log('Latest sensor data found:', latestData);
                    
                    return {
                        heartRate: latestData.heartRate || 0,
                        spo2: latestData.spo2 || 0,
                        accelX: latestData.accelX || 0,
                        accelY: latestData.accelY || 0,
                        accelZ: latestData.accelZ || 1.0,
                        gyroX: latestData.gyroX || 0,
                        gyroY: latestData.gyroY || 0,
                        gyroZ: latestData.gyroZ || 0,
                        timestamp: Date.now()
                    };
                } else {
                    console.log('No sensor data found');
                    return null;
                }
            } catch (error) {
                console.error('Error fetching sensor data:', error);
                return null;
            }
        }

        // Load user profile and health data
        async function loadUserData(user) {
            try {
                console.log('Loading user data for:', user.uid);
                
                // Get user profile data from Firestore
                const userDoc = await db.collection('users').doc(user.uid).get();
                
                if (userDoc.exists) {
                    const userData = userDoc.data();
                    
                    // Update profile information
                    firstName.textContent = userData.firstName || 'Not set';
                    lastName.textContent = userData.lastName || 'Not set';
                    userEmail.textContent = userData.email || user.email;
                    userFullName.textContent = `${userData.firstName || ''} ${userData.lastName || ''}`.trim() || 'User';
                    userId.textContent = user.uid.substring(0, 8) + '...';
                    
                    // Update avatar with initials
                    const initials = (userData.firstName?.charAt(0) || '') + (userData.lastName?.charAt(0) || '');
                    if (initials) {
                        userAvatar.innerHTML = initials;
                    }
                } else {
                    firstName.textContent = 'Not set';
                    lastName.textContent = 'Not set';
                    userEmail.textContent = user.email;
                    userId.textContent = user.uid.substring(0, 8) + '...';
                }
                
                // Get health data from sensorData path
                showMessage('Fetching real-time sensor data...', 'info');
                const sensorData = await getLatestSensorData();
                
                if (sensorData && sensorData.heartRate && sensorData.spo2) {
                    // Update health metrics
                    heartRate.textContent = sensorData.heartRate;
                    oxygenLevel.textContent = sensorData.spo2;
                    
                    // Update timestamps
                    const timeText = formatTimestamp(sensorData.timestamp);
                    heartUpdated.textContent = `Updated: ${timeText}`;
                    oxygenUpdated.textContent = `Updated: ${timeText}`;
                    lastUpdateTime.textContent = `Last update: ${timeText}`;
                    
                    updateHealthStatus(sensorData.heartRate, sensorData.spo2);
                    
                    // Process IMU data for step counting
                    if (sensorData.accelX !== undefined && 
                        sensorData.accelY !== undefined && 
                        sensorData.accelZ !== undefined) {
                        
                        console.log('Processing IMU data:', {
                            accelX: sensorData.accelX,
                            accelY: sensorData.accelY,
                            accelZ: sensorData.accelZ,
                            heartRate: sensorData.heartRate
                        });
                        
                        stepCounter.processIMUData(
                            sensorData.accelX,
                            sensorData.accelY,
                            sensorData.accelZ,
                            sensorData.timestamp,
                            sensorData.heartRate
                        );
                    }
                    
                    // Update step count display
                    const steps = stepCounter.getStepCount();
                    stepsCount.textContent = steps.toLocaleString();
                    updateStepStatus(steps);
                    
                    // Generate demo sleep data
                    sleepHours.textContent = (Math.random() * 3 + 5).toFixed(1);
                    
                    showMessage('Sensor data loaded successfully!', 'success');
                } else {
                    // Use fallback data
                    const fallbackHeartRate = 72;
                    const fallbackOxygenLevel = 98;
                    
                    heartRate.textContent = fallbackHeartRate;
                    oxygenLevel.textContent = fallbackOxygenLevel;
                    
                    heartUpdated.textContent = 'Demo data';
                    oxygenUpdated.textContent = 'Demo data';
                    lastUpdateTime.textContent = 'Last update: Demo data';
                    
                    const steps = stepCounter.getStepCount();
                    stepsCount.textContent = steps.toLocaleString();
                    updateStepStatus(steps);
                    
                    sleepHours.textContent = '7.2';
                    
                    updateHealthStatus(fallbackHeartRate, fallbackOxygenLevel);
                    
                    showMessage('Using demo health data - no sensor data found', 'info');
                }
                
            } catch (error) {
                console.error('Error loading user data:', error);
                showMessage('Error loading data: ' + error.message, 'error');
            }
        }

        // Setup real-time listener for health data from sensorData path
        function setupRealtimeListener() {
            console.log('Setting up real-time sensor data listener...');
            
            const sensorDataRef = rtdb.ref('sensorData');
            
            sensorDataRef.on('value', (snapshot) => {
                const data = snapshot.val();
                
                if (data) {
                    // Get the latest sensor reading
                    const sensorKeys = Object.keys(data);
                    const latestKey = sensorKeys[sensorKeys.length - 1];
                    const latestData = data[latestKey];
                    
                    if (latestData && latestData.heartRate !== undefined && latestData.spo2 !== undefined) {
                        // Update UI with real-time data
                        heartRate.textContent = latestData.heartRate;
                        oxygenLevel.textContent = latestData.spo2;
                        
                        const timeText = formatTimestamp(Date.now());
                        heartUpdated.textContent = `Updated: ${timeText}`;
                        oxygenUpdated.textContent = `Updated: ${timeText}`;
                        lastUpdateTime.textContent = `Last update: ${timeText}`;
                        
                        // Update status indicators
                        updateHealthStatus(latestData.heartRate, latestData.spo2);
                        
                        // Process IMU data for step counting if available
                        if (latestData.accelX !== undefined && 
                            latestData.accelY !== undefined && 
                            latestData.accelZ !== undefined) {
                            
                            const stepDetected = stepCounter.processIMUData(
                                latestData.accelX,
                                latestData.accelY,
                                latestData.accelZ,
                                Date.now(),
                                latestData.heartRate
                            );
                            
                            if (stepDetected) {
                                console.log('ðŸš¶ Step detected! Total steps:', stepCounter.getStepCount());
                            }
                            
                            // Update step count display
                            const steps = stepCounter.getStepCount();
                            stepsCount.textContent = steps.toLocaleString();
                            updateStepStatus(steps);
                        }
                        
                        console.log('Health data updated:', {
                            heartRate: latestData.heartRate,
                            spo2: latestData.spo2,
                            steps: stepCounter.getStepCount()
                        });
                    }
                }
            }, (error) => {
                console.error('Error in real-time listener:', error);
                showMessage('Error updating health data', 'error');
            });
            
            // Check for daily reset every minute
            setInterval(() => {
                stepCounter.checkDailyReset();
                const steps = stepCounter.getStepCount();
                stepsCount.textContent = steps.toLocaleString();
                updateStepStatus(steps);
            }, 60000);
        }

        // Logout function
        function logout() {
            auth.signOut().then(() => {
                window.location.href = 'login.html';
            }).catch((error) => {
                console.error('Logout error:', error);
                showMessage('Error during logout. Please try again.', 'error');
            });
        }

        // Check authentication state
        auth.onAuthStateChanged((user) => {
            if (user) {
                console.log('User is signed in:', user.uid);
                loadUserData(user);
                setupRealtimeListener();
            } else {
                console.log('User is signed out, redirecting to login');
                window.location.href = 'login.html';
            }
        });

        // Event listeners
        logoutBtn.addEventListener('click', logout);
    </script>
</body>
</html>
